\begin{frame}{mutation with relocation}
    \begin{itemize}
    \item problem: mutations mess up jumps/calls
        \begin{itemize}
        \item change were targets of jumps/calls are
        \end{itemize}
    \item table mapping old to new locations
        \begin{itemize}
        \item list of number of bytes generated by each transformation
        \end{itemize}
    \item list of locations references in original
        \begin{itemize}
        \item record relative offset in jump
        \item record absolute offset in original
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}[fragile,label=relocEx]{relocation example}
\lstset{language=myasm,style=small}
\begin{tikzpicture}
\node (code) {
\begin{lstlisting}
    mov ...
    mov ...
decrypt:
    xor %rax, (%rbx)
    inc %rbx
    dec %rcx
    jne decrypt
\end{lstlisting}
};
\matrix[tight matrix,nodes={font=\small},anchor=north west,
    nodes={font=\tt,text width=2cm,text depth=.1mm,minimum height=.4cm},
    row 1/.style={nodes={font=\small\bfseries,minimum height=1cm}},
    column 1/.style={text=blue!60!black,nodes={text width=1.75cm}},
    column 2/.style={text=green!60!black},
    column 3/.style={nodes={text width=1.5cm,font=\small\tt}},
] (lensTable) at ([xshift=1cm]code.north east) {
    orig. len \& new len \& instr \\
    5 \& 10 \& mov1 \\
    2 \& 3 \& mov2 \\
    2 \& 7 \& xor1 \\
    1 \& 1 \& inc1 \\
    1 \& 5 \& dec1 \\
    3 \& 3 \& jne1 \\
};
\matrix[tight matrix,nodes={font=\fontsize{9}{10}\selectfont,minimum height=1.2cm},anchor=north west,
    nodes={font=\tt,text width=4cm},
    row 1/.style={nodes={font=\small\bfseries,minimum height=1cm}},
    column 2/.style={text=blue!60!black},
    column 1/.style={text=green!60!black},
    column 3/.style={text=green!60!black},
] (relocTable) at ([yshift=-.5cm,xshift=-6.5cm]lensTable.south west) {
    address loc \& orig. target \& new target \\
    $10+3+7+1+5+1$ (jne1+1) \& xor1 ($5+2$)\& xor1 ($10+3$)\\ 
};
\end{tikzpicture}
\end{frame}

