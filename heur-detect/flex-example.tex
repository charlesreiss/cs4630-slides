\usetikzlibrary{fit}

\begin{frame}{flex}
    \begin{itemize}
    \item flex is a regular expression matching tool
    \item intended for writing \myemph{parsers}
    \item generates \myemph{C code}
    \item parser function called {\tt yylex}
    \end{itemize}
\end{frame}

\newsavebox\flexExTop
\newsavebox\flexExMiddle
\newsavebox\flexExBottom
\lstset{style=small,language={}}
\begin{lrbox}{\flexExTop}
\begin{lstlisting}
        int num_bytes = 0, num_lines = 0;
        int num_foos = 0;
\end{lstlisting}
\end{lrbox}

\begin{lrbox}{\flexExMiddle}
\begin{lstlisting}
foo     { 
          num_bytes += 3;
          num_foos += 1;
        }
.       { num_bytes += 1; }
\n      { num_lines += 1; num_bytes += 1; }
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\flexExBottom}
\begin{lstlisting}
int main(void) {
    yylex();
    printf("%d bytes, %d lines, %d foos\n",
           num_bytes, num_lines, num_foos);
}
\end{lstlisting}
\end{lrbox}

\begin{frame}[fragile,label=flexEx]{flex example}
\begin{tikzpicture}
\begin{scope}
\tikzset{every node/.style={font=\small,align=left,anchor=north west,inner sep=0mm}}
\node (vars) {
\usebox{\flexExTop}
};
\node (patMacros) at (vars.south west) {
~
};
\node (sepA) at (patMacros.south west) {
\tt  \%\%
};
\node (pats) at (sepA.south west) {
\usebox{\flexExMiddle}
};
\node (sepB) at (pats.south west) {
\tt \%\%
};
\node (mainCode) at (sepB.south west) {
\usebox{\flexExBottom}
};
\end{scope}

\tikzset{
    hi/.style={rounded corners,fill=green,opacity=0.3},
    remark/.style={draw,red,very thick,at={([xshift=-3cm]pats.east)},fill=white,align=left},
    remark2/.style={draw,red,very thick,at={([xshift=-3cm,yshift=2cm]pats.east)},fill=white,align=left},
}

\begin{visibleenv}<2>
    \node[hi,fit=(sepA)] {};
    \node[hi,fit=(sepB)] {};
    \node[remark] {three sections};
\end{visibleenv}

\begin{visibleenv}<3>
    \node[hi,fit=(vars)] {};
    \node[remark] {first --- declarations for later \\
                   C code in output file};
\end{visibleenv}

\begin{visibleenv}<4>
    \node[hi,fit=(pats)] {};
    \node[remark2] {patterns, code to run on match \\
                   as parser: return ``token'' here};
\end{visibleenv}

\begin{visibleenv}<5>
    \node[hi,fit=(mainCode)] {};
    \node[remark] {extra code to include};
\end{visibleenv}

\end{tikzpicture}
\end{frame}

\begin{lrbox}{\flexExTop}
\begin{lstlisting}
        int num_bytes = 0, num_lines = 0;
        int num_foos = 0;
\end{lstlisting}
\end{lrbox}

\begin{lrbox}{\flexExMiddle}
\begin{lstlisting}
[aA][a-z]* {
               printf("found a-word '%s'\n",
                      ~2~yytext~end~);
           }
(.|\n)     {} /* default rule: would output text */
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\flexExBottom}
\begin{lstlisting}
int main(void) {
    yylex();
}
\end{lstlisting}
\end{lrbox}

\begin{frame}[fragile,label=flexMatched]{flex: matched text}
\lstset{
        style=small,
        language={},
        moredelim={**[is][\btHL<2|handout:0>]{~2~}{~end~}},
        }
\begin{tikzpicture}
\begin{scope}
\tikzset{every node/.style={font=\small,align=left,anchor=north west,inner sep=0mm}}
\node (vars) {
};
\node (patMacros) at (vars.south west) {
~
};
\node (sepA) at (patMacros.south west) {
\tt \%\%
};
\node (pats) at (sepA.south west) {
\usebox{\flexExMiddle}
};
\node (sepB) at (pats.south west) {
\%\%
};
\node (mainCode) at (sepB.south west) {
\usebox{\flexExBottom}
};
\end{scope}
\tikzset{
    hi/.style={rounded corners,fill=green,opacity=0.3},
    remark/.style={draw,red,very thick,at={([xshift=-4cm,yshift=2cm]pats.east)},fill=white,align=left},
}
\begin{visibleenv}<2>
    \node[remark] {yytext --- text of matched thing};
\end{visibleenv}
\end{tikzpicture}
\end{frame}

\begin{lrbox}{\flexExTop}
\begin{lstlisting}
A        [aA]
LOWERS   [a-z]
ANY      (.|\n)
\end{lstlisting}
\end{lrbox}

\begin{lrbox}{\flexExMiddle}
\begin{lstlisting}
{A}{LOWERS}* {
                printf("found a-word '%s'\n",
                       yytext);
             }
{ANY}        {} /* default rule would
                   output text */
\end{lstlisting}
\end{lrbox}

\begin{frame}[fragile,label=flexDef]{flex: definitions}
\lstset{
        style=small,
        language={},
        moredelim={**[is][\btHL<2|handout:0>]{@hi2@}{@endhi@}},
        }
\begin{tikzpicture}
\begin{scope}
\tikzset{every node/.style={font=\small,align=left,anchor=north west,inner sep=0mm}}
\node (vars) {
};
\node (patMacros) at (vars.south west) {
\usebox{\flexExTop}
};
\node (sepA) at (patMacros.south west) {
\%\%
};
\node (pats) at (sepA.south west) {
\usebox{\flexExMiddle}
};
\node (sepB) at (pats.south west) {
\%\%
};
\node (mainCode) at (sepB.south west) {
\usebox{\flexExBottom}
};
\end{scope}
\tikzset{
    hi/.style={rounded corners,fill=green,opacity=0.3},
    remark/.style={draw,red,very thick,at={([xshift=-4cm,yshift=2cm]pats.east)},fill=white,align=left},
}
\begin{visibleenv}<2>
    \node[hi,fit=(patMacros)] {};
    \node[remark] {definitions of common patterns \\ included later};
\end{visibleenv}
\end{tikzpicture}
\end{frame}
