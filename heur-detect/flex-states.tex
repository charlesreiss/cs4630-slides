
\newsavebox\flexStatesTop
\newsavebox\flexStatesMiddle
\newsavebox\flexStatesBottom
\lstset{style=small,language={}}
\begin{lrbox}{\flexStatesTop}
\begin{lstlisting}
%x str
\end{lstlisting}
\end{lrbox}

\begin{lrbox}{\flexStatesMiddle}
\begin{lstlisting}
\"          { BEGIN(str); }
<str>\"     { BEGIN(INITIAL); }
<str>foo    { printf("foo in string\n"); }
foo         { printf("foo out of string\n"); }
<INITIAL,str>(.|\n) {}
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\flexStatesBottom}
\begin{lstlisting}
int main(void) {
    yylex();
}
\end{lstlisting}
\end{lrbox}

\begin{frame}[fragile,label=flexStates]{flex states (1)}
\lstset{
        style=small,
        language={},
        moredelim={**[is][\btHL<2|handout:0>]{@hi2@}{@endhi@}},
        }
\begin{tikzpicture}
\begin{scope}
\tikzset{every node/.style={font=\small,align=left,anchor=north west,inner sep=0mm}}
\node (vars) {
};
\node (patMacros) at (vars.south west) {
\usebox{\flexStatesTop}
};
\node (sepA) at (patMacros.south west) {
\%\%
};
\node (pats) at (sepA.south west) {
\usebox{\flexStatesMiddle}
};
\node (sepB) at (pats.south west) {
\%\%
};
\node (mainCode) at (sepB.south west) {
\usebox{\flexStatesBottom}
};
\end{scope}
\tikzset{
    hi/.style={rounded corners,fill=green,opacity=0.3},
    remark/.style={draw,red,very thick,at={([xshift=-5cm,yshift=-2cm]pats.east)},fill=white,align=left},
}
\begin{visibleenv}<2>
    \node[hi,fit=(patMacros)] {};
    \node[remark] {
        declare ``state'' to track \\
        which state determines what patterns are active \\
        \only<3->{``x'' --- exclusive}
    };
\end{visibleenv}
\end{tikzpicture}
\end{frame}


\begin{lrbox}{\flexStatesTop}
\begin{lstlisting}
%s afterFoo
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\flexStatesMiddle}
\begin{lstlisting}
<afterFoo>foo    { printf("later foo\n"); }
foo              {
                   printf("first foo\n"); 
                   BEGIN(afterfoo);
                 }
(.|\n)  {}  
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\flexStatesBottom}
\begin{lstlisting}
int main(void) {
    yylex();
}
\end{lstlisting}
\end{lrbox}

\begin{frame}[fragile,label=flexStates2]{flex states (2)}
\begin{tikzpicture}
\begin{scope}
\tikzset{every node/.style={font=\small,align=left,anchor=north west,inner sep=0mm}}
\node (vars) {
};
\node (patMacros) at (vars.south west) {
\usebox{\flexStatesTop}
};
\node (sepA) at (patMacros.south west) {
\%\%
};
\node (pats) at (sepA.south west) {
\usebox{\flexStatesMiddle}
};
\node (sepB) at (pats.south west) {
\%\%
};
\node (mainCode) at (sepB.south west) {
\usebox{\flexStatesBottom}
};
\end{scope}
\tikzset{
    hi/.style={rounded corners,fill=green,opacity=0.3},
    remark/.style={draw,red,very thick,at={([xshift=-4cm,yshift=2cm]pats.east)},fill=white,align=left},
}
\begin{visibleenv}<2>
    \node[hi,fit=(patMacros)] {};
    \node[remark] {
        declare non-exclusive state
    };
\end{visibleenv}
\end{tikzpicture}
\end{frame}

