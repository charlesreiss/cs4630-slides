
### Linux stack randomization (x86-64)  {.smaller}



1. choose random number between <code>0</code> and <code>0x3F FFFF</code>
2. stack starts at <code>0x7FFF FFFF FFFF</code> - <i>random number</i> $\times$ <code>0x1000</code>  
   * randomization disabled? <i>random number</i> $= 0$
   * times <code>0x1000</code> because OS has to allocate whole pages (0x1000 bytes)
   * results in 16GB range


### program memory (x86-64 Linux; ASLR) 



![](/mitigate-aslr/texfig/aslr64.figure.svg){fig-alt="diagram of program memory layout; OS region at 0xFFFF_8000_0000_0000 through 0xFFFF_FFFF_FFFF_FFFF; stack below that at an (unspecified) address +/- 0x4_0000_0000; mmap/non-fixed executables/libraries below that at an address +/- 0x100_0000_0000 (fillled from top with ASLR); heap below that with a +/- 0x200_0000 starting address; fixed executable writeable at 0x60_0000; fixed executable code/data at 0x40_0000"}


### program memory (x86-32 Linux; ASLR) 

![](/mitigate-aslr/texfig/aslr-entropy-program-memory-x86-32-linux-aslr.figure.svg){fig-alt="diagram of program memory layout; OS region at 0xC000_0000 through 0xFFFF_FFFF; stack below that an (unspecified) address +/- 0x80_0000 (by default); dynamic allocations (mmap) and libraries below that an address +/- 0x8_0000 (by default); heap allocations (brk/sbrk) below that an address +/- 0x200_0000; then fixed executable writeable data (sometimes); then fixed executable code/data at 0x804_8000"}

### how much guessing?  {.smaller}

* gaps change by multiples of page size (4KB) 
   * lower 12 bits are <em>fixed</em>
* 64-bit: <em>huge</em> ranges --- need millions of guesses 
   * about <em>30 randomized bits</em> in addresses
* 32-bit: <em>smaller</em> ranges --- hundreds of guesses 
   * only about <em>8 randomized bits</em> in addresses
   * why? only 4 GB to work with!
   * can be configured higher --- but larger gaps
      *  limits effective usable space

### how can we get multiple guesses? 

* how can we get multiple guesses?
<hr class="vspace" />
* wrong guess might not crash
* wrong guess might not crash whole application 
   * e.g. server that uses multiple processes
* local programs we can repeatedly run
* servers that are automatically restarted
   * varies whether "re-randomized"

