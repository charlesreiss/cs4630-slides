
### Vienna relocation  {.smaller}

<!-- \lstset{
    style=small,
    language=myasm,
    moredelim={**[is][\btHL<1|handout:0>]{@hi1@}{@endhi@}},
    moredelim={**[is][\btHL<2|handout:0>]{@hi2@}{@endhi@}},
    moredelim={**[is][\btHL<3|handout:0>]{@hi3@}{@endhi@}},
} -->
 <pre><code>// set virus data address:
0x700: <span data-fragment-index="1" class="fragment custom myem-only">mov $0x8f9, %si</span>
       // machine code: be f9 08
       // be: opcode
       // f9 08: immediate
...
// %ax contains file length (of file to infect)
mov %ax, %cx
...
<span data-fragment-index="3" class="fragment custom myem-only">add $0x2f9, %cx</span>
mov %si, %di   
sub $0x1f7, %di // %di &lt;- 0x701
<span data-fragment-index="2" class="fragment custom myem-only">mov %cx, (%di)</span>  // update mov instruction
...
</code></pre>
 ![](texfig/virusReloc2.figure.svg){.absolute top="0%" left="0%" width=1050 height=600 .my-center }


### Vienna relocation 


* edit actual code for <code>mov</code>
* why doesn't this disrupt virus execution? 

   * already ran that instruction



### Vienna relocation  {.smaller}

<!-- \lstset{
    style=smaller,
    language=myasm,
    moredelim={**[is][\btHL<2|handout:0>]{@hi2@}{@endhi@}},
    moredelim={**[is][\btHL<3|handout:0>]{@hi3@}{@endhi@}},
} -->
 <pre><code>0x700: mov $0x8f9, %si
...
// %ax contains file length
//     (of file to infect)
mov %ax, %cx
sub $3, %ax
// update template jmp instruction
mov %ax, <span data-fragment-index="2" class="fragment custom myem-only">0xe(%si)</span> // 0xe + %si = 0x907
...
mov $40, %ah
mov $3, %cx
mov %si, %dx  
add $0xD, <span data-fragment-index="3" class="fragment custom myem-only">%dx</span> // dx &lt;- 0x906
int 0x21 // system call: write 3 bytes from 0x906
...
0x906: <span data-fragment-index="2" class="fragment custom myem-only">e9 fd 05</span> // jmp PC+FD 05
</code></pre>

