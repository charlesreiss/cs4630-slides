\usetikzlibrary{calc,shapes}
\usetikzlibrary{graphdrawing}
\usetikzlibrary{graphs}
\usegdlibrary{trees}

\begin{frame}[fragile,label=choosePath0]{example 0}
\lstset{language=C,style=smaller}
\begin{lstlisting}
int foo(int a, int b) {
    // (0)
    a += b * 2;
    // (1)
    b *= 4;
    // (2)
    return a + b;
}
\end{lstlisting}
    \begin{tikzpicture}[overlay, remember picture]
        \tikzset{
            every node/.style={font=\scriptsize},
            condition/.style={draw=red,thick,ellipse},
            question/.style={fill=red!20,draw=black,thick,align=left},
            dashedQuestion/.style={fill=red!20,draw=black,dashed,thick,align=left},
            state/.style={draw=blue,thick,rectangle,align=center},
            invisible/.style={opacity=0,text opacity=0},
        }
        \begin{scope}[tree layout,grow=down]
            \node[state,desired at={([xshift=-5cm,yshift=-2cm]current page.north east)}] (top) {at (0): \\
                a: $\alpha$, b: $\beta$}
                child {
                    node[state,visible on=<2->] {at (1): \\
                        a: $\alpha + 2\beta$, b: $\beta$
                    }
                    child {
                        node[state,visible on=<3->] {at (2): \\
                            a: $\alpha + 2\beta$, b: $4\beta$
                        }
                        child {
                            node[state,visible on=<4->] {after func: \\
                            return: $\alpha + 2\beta + 4\beta = \alpha+6\beta$
                            }
                        }
                    }
                }
        
                ;
        \end{scope}
    \end{tikzpicture}
\begin{itemize}
\item<5-> can express return value of function in terms of arguments
\item<5-> then can solve for possible value of arguments
\item<5-> example: if return == 10, then can enumerate:
    \begin{itemize}
    \item (\alpha,\beta) = (10,0)
    \item (\alpha,\beta) = (4,1)
    \item (\alpha,\beta) = (-2,2)
    \item \ldots
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{actually doing this}
\begin{itemize}
\item angr is a binary analysis toolkit written in Python
    \begin{itemize}
    \item has Ghidra-like GUI, but not very stable/maintained as far as I can tell
    \end{itemize}
\item among other things, converts assembly into intermediate form
\item supports symbolic execution
\end{itemize}
\end{frame}

\begin{frame}[fragile]{angr setup}
\begin{Verbatim}[fontsize=\fontsize{10}{11},commandchars=\\\{\}]
import angr
import claripy

p = angr.Project("./example0",
                 load_options={'auto_load_libs': False})

foo_addr = p.loader.main_object.get_symbol('foo').rebased_addr
input_a = claripy.BVS('initial_a', 32) # \textit{32-bit bit vector}
input_b = claripy.BVS('initial_b', 32) # \textit{32-bit bit vector}
init_state = p.factory.call_state(foo_addr, input_a, input_b)
simgr = p.factory.simulation_manager(init_state)
# \textit{<SimulationManager with 1 active>}
\end{Verbatim}
\end{frame}

\begin{frame}[fragile]{angr running}
\begin{Verbatim}[fontsize=\fontsize{10}{11},commandchars=\\\{\}]
print(f"RIP={simgr.active[0].regs.rip} versus {foo_addr:#x}")
    # \textit{RIP=<BV64 0x4011f9> versus 0x4011f9}
print(f"EAX={simgr.active[0].regs.eax}")
    # \textit{RAX=<BV reg_eax_3_32>} (unknown value)
simgr.step()
    # simgr = \textit{<SimulationManager with 1 active>}
simgr.step()
    # simgr = \textit{<SimulationManager with 1 deadended>}
state = simgr.deadended[0]
print(f"EAX={state.regs.eax}")
    # \textit{EAX=initial_a_0_32 + }
    # \textit{     (initial_b_1_32[30:0] .. 0) +}
    # \textit{     (initial_b_1_32[29:0] .. 0)}
state.solver.add(state.regs.eax == 10)
print(state.solver.eval(input_a), state.solver.eval(input_b))
    # \textit{10 0}
state.solver.add(input_b != 0)
print(state.solver.eval(input_a), state.solver.eval(input_b))
    # \textit{4294901754 715838808}
\end{Verbatim}
\end{frame}


\begin{frame}[fragile,label=choosePath0]{example 1}
\lstset{language=C,style=smaller}
\begin{lstlisting}
void foo(int a, int b) {
  /* (0) */
  if (a != 0) {
    b -= 2;
    a += b;
  }
  /* (1) */
  if (b < 5) {
    b += 4;
  }
  /* (2) */
  if (a + b == 5)
    INTERESTING();
}
\end{lstlisting}
    \begin{tikzpicture}[overlay, remember picture]
        \tikzset{
            every node/.style={font=\scriptsize},
            condition/.style={draw=red,thick,ellipse},
            question/.style={fill=red!20,draw=black,thick,align=left},
            dashedQuestion/.style={fill=red!20,draw=black,dashed,thick,align=left},
            state/.style={draw=blue,thick,rectangle,align=center},
            invisible/.style={opacity=0,text opacity=0},
        }
        \begin{scope}[tree layout,grow=down]
            \node[state,desired at={([xshift=-5cm,yshift=-2cm]current page.north east)}] (top) {at (0): \\ a: $\alpha$, b: $\beta$}
                child { node[condition,visible on=<2->] { a != 0 }
                    child { node[state,visible on=<3->,alt=<4>{very thick}{thick}] {at (1): \\ $\alpha\not=0$\\a: $\alpha+\beta - 2$, b: $\beta - 2$} edge from parent[visible on=<3->] node {true}
                        child { node[condition,visible on=<4->] { b < 5 } edge from parent[visible on=<4->]
                            child {
                                node[state,visible on=<5->] {
                                    at (2): \\ $\alpha\not=0\text{; }\beta-2<5$ \\ a: $\alpha+\beta-2$, b: $\beta + 2$
                                } edge from parent[visible on=<5->] node {true}
                                child {
                                    node[question,visible on=<6->] {
                                        $\alpha \not= 0$; $\beta - 2 < 5$; \\
                                        $\alpha + 2\beta = 5$? \\
                                        \hrulefill
                                        \text{can} happen: $(\alpha,\beta)=(5,0)$
                                    } edge from parent[visible on=<6->]
                                }
                            }
                            child { node[state,visible on=<7->] {at (2): \\ $\alpha\not=0\text{; }\beta-2\ge5$ \\ a: $\alpha+\beta-2$, b: $\beta - 2$}
                                edge from parent[visible on=<7->] node {false}
                                child { node[visible on=<7->,dashedQuestion] {} edge from parent[visible on=<7->] }
                            }
                        }
                    }
                    child { node[state,visible on=<3->] {at (1): \\ $\alpha=0$\\a: $\alpha$, b: $\beta$} edge from parent[visible on=<3->] node {false}
                        child { node[condition,visible on=<8->] { b < 5 } 
                            edge from parent[visible on=<8->]
                            child { node[state,visible on=<8->] {at (2): \\ $a=0\text{; }\beta<5$ \\ a: $\alpha$, b: $\beta+4$} edge from parent[visible on=<8->] node {true}
                                child { node[visible on=<8->,dashedQuestion] {} edge from parent[visible on=<8->] }
                            }
                            child { node[state,visible on=<8->] {at (2): \\ $a=0\text{; }\beta\ge5$ \\ a: $\alpha$, b: $\beta$} edge from parent[visible on=<8->] node {false}
                                child { node[visible on=<8->,dashedQuestion] {} edge from parent[visible on=<8->] }
                            }
                        }
                    }
                }
                ;
        \end{scope}
    \end{tikzpicture}
    \begin{itemize}
        \item<2> every variable represented as an \myemph{equation}
        \item<2> final step: generate solution for each path
            \begin{itemize}
                \item 100\% test coverage
            \end{itemize}
    \end{itemize}
\imagecredit{Adapted from Hicks, ``Symbolic Execution for Finding Bugs''}
\end{frame}

% FIXME: angr code for this

\begin{frame}[fragile,label=choosePath1]{example 2}
\lstset{language=C,style=smaller}
\begin{lstlisting}
void foo(unsigned a,
         unsigned b,
         unsigned c) {
  if (a != 0) {
    b -= c; // W
  }
  if (b < 5) {
    if (b > c) {
      a += b; // X
    }
    b += 4; // Y
  } else {
    a += 1; // Z
  }
  if (a + b != 7)
    INTERESTING();
}
\end{lstlisting}
    \begin{tikzpicture}[overlay, remember picture]
        \tikzset{
            every node/.style={font=\scriptsize},
            condition/.style={draw=red,thick,ellipse},
            question/.style={fill=red!20,draw=black,thick,align=left},
            dashedQuestion/.style={fill=red!20,draw=black,dashed,thick,align=left},
            state/.style={draw=blue,thick,rectangle,align=center},
            dashedState/.style={draw=blue,dashed,thick,rectangle,align=center},
            invisible/.style={opacity=0,text opacity=0},
        }
        \begin{scope}[tree layout,grow=down]
            \node[state,desired at={([xshift=-3cm,yshift=-.5cm]current page.north east)}] (top) {a: $\alpha$, b: $\beta$, c: $\delta$}
                child { node[condition,visible on=<2->] { a != 0 }
                    child { node[state,visible on=<3->,alt=<4>{very thick}{thick}] {$\alpha\not=0$\\a: $\alpha$, b: $\beta - \delta$} edge from parent[visible on=<3->] node {true}
                        child { node[condition,visible on=<4->] { b < 5 } edge from parent[visible on=<4->]
                            child {
                                node[state,visible on=<5->] {
                                    $\alpha\not=0\text{; }\beta-\delta<5$ \\ a: $\alpha$, \\ b: $\beta -\delta$
                                } edge from parent[visible on=<5->] node {true}
                                child {
                                    node[condition,visible on=<6->] {
                                        a > c
                                    }
                                    child {
                                        node[state,visible on=<6->] {
                                            $\alpha\not=0\text{; }\beta-\delta<5\text{; }\beta>\delta$ \\
                                            a: $\alpha+\beta-\delta$, \\ b: $\beta -\delta + 4$
                                        }
                                        child {
                                            node[question,visible on=<7->] {
                                                $\alpha \not= 0$; $\beta- \delta < 5$; $\beta>\delta$ \\
                                                $\alpha + 2\beta- 2\delta + 4= 7$? \\
                                                \hrulefill
                                                \text{can} happen: $(\alpha,\beta,\delta)=(5, 0, 1)$
                                            } edge from parent[visible on=<7->]
                                        }
                                    }
                                    child {
                                        node[state,visible on=<8->] {
                                            $\alpha \not= 0$; $\beta-\delta < 5$; $\beta\le\delta$ \\
                                            a: $\alpha$, \\ b: $\beta - \delta + 4$
                                        } edge from parent[visible on=<8->]
                                        child {
                                            node[dashedQuestion] {}
                                        }
                                    }
                                }
                            }
                            child { node[state,visible on=<9->] {$\alpha\not=0\text{; }\beta-\delta\ge5$ \\ a: $\alpha+\beta-2$, \\ b: $\beta - 2$}
                                edge from parent[visible on=<9->] node {false}
                                child { node[visible on=<9->,dashedQuestion] {} edge from parent[visible on=<7->] }
                            }
                        }
                    }
                    child { node[state,visible on=<3->] {$\alpha=0$\\a: $\alpha$, \\ b: $\beta$} edge from parent[visible on=<3->] node {false}
                        child { node[dashedQuestion] {} }
                        }
                    }
                ;
        \end{scope}
    \end{tikzpicture}
\imagecredit{Adapted from Hicks, ``Symbolic Execution for Finding Bugs''}
\end{frame}


